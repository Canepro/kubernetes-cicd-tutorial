name: CI/CD Pipeline
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. FIX PATH: Ensures the runner finds our Podman shim (D:\podman-data)
      - name: Add Podman docker shim to PATH
        shell: pwsh
        run: |
          "D:\podman-data" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Added D:\podman-data to GITHUB_PATH"

      # 2. WAKE UP VM: Prevents connection errors if the PC was idle
      - name: Ensure Podman machine is running
        shell: pwsh
        run: |
          podman machine start
          podman machine list

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.CR_PAT }}

      # 3. BUILD & PUSH: Lowers case and uses explicit "docker://" transport for reliability
      - name: Build and push Docker image
        shell: pwsh
        run: |
          $imageRepo = "ghcr.io/${{ github.repository }}".ToLower()
          $tagLatest = "${imageRepo}:latest"
          $tagSha    = "${imageRepo}:${{ github.sha }}"

          Write-Host "Target Image: $tagLatest"

          docker build -t $tagLatest -t $tagSha .
          podman push $tagLatest "docker://$tagLatest"
          podman push $tagSha    "docker://$tagSha"

      # 4. GITOPS UPDATE: Uses PowerShell to handle paths and casing automatically
      - name: Update GitOps repository
        shell: pwsh
        env:
          GIT_TOKEN: ${{ secrets.GITOPS_PAT }}
        run: |
          # Configure credentials
          git config --global credential.helper store
          "https://$env:GIT_TOKEN:x-oauth-basic@github.com" | Set-Content "$env:USERPROFILE\.git-credentials"

          # Clean & Clone
          Remove-Item -Recurse -Force gitops -ErrorAction SilentlyContinue
          git clone https://github.com/canepro/grade-api-gitops.git gitops
          Set-Location gitops

          # Update Deployment Manifest
          # PowerShell -replace is case-insensitive, so it finds 'Canepro' and replaces with 'canepro' automatically.
          $repoLc = "${{ github.repository }}".ToLower()
          (Get-Content deployment.yaml) -replace "image:\s*ghcr\.io/$repoLc:.*", "image: ghcr.io/$repoLc:${{ github.sha }}" |
            Set-Content deployment.yaml

          # Commit & Push
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add deployment.yaml
          # 2>$null suppresses the error if there is nothing new to commit
          git commit -m "Update image to ${{ github.sha }}" 2>$null
          git push -f "https://$env:GIT_TOKEN@github.com/canepro/grade-api-gitops.git" main

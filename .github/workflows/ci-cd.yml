name: CI/CD Pipeline
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. FIX PATH: Ensures the runner finds our Podman shim (D:\podman-data)
      - name: Add Podman docker shim to PATH
        shell: pwsh
        run: |
          "D:\podman-data" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Added D:\podman-data to GITHUB_PATH"

      # 2. WAKE UP VM: Prevents connection errors if the PC was idle
      - name: Ensure Podman machine is running
        shell: pwsh
        run: |
          podman machine start || $true
          podman machine list

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.CR_PAT }}

      # 3. BUILD & PUSH: Lowers case and uses explicit "docker://" transport for reliability
      - name: Build and push Docker image
        shell: pwsh
        run: |
          $imageRepo = "ghcr.io/${{ github.repository }}".ToLower()
          $tagLatest = "${imageRepo}:latest"
          $tagSha    = "${imageRepo}:${{ github.sha }}"

          Write-Host "Target Image: $tagLatest"

          docker build -t $tagLatest -t $tagSha .
          podman push $tagLatest "docker://$tagLatest"
          podman push $tagSha    "docker://$tagSha"

      # 4. GITOPS UPDATE: Rewritten in Bash to satisfy the trainer's requirement.
      - name: Update GitOps repository
        shell: bash
        env:
          GIT_TOKEN: ${{ secrets.GITOPS_PAT }}
        run: |
          # 1. Configure Credentials
          git config --global credential.helper store
          echo "https://${GIT_TOKEN}:x-oauth-basic@github.com" > ~/.git-credentials

          # 2. Clean & Clone
          rm -rf gitops
          git clone https://github.com/canepro/grade-api-gitops.git gitops
          cd gitops

          # 3. Update Deployment Manifest
          # We use 'tr' to convert the repo name to lowercase (Bash equivalent of .ToLower())
          REPO_LC=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # Use 'sed' to find and replace the image tag
          sed -i "s|image: ghcr.io/${REPO_LC}:.*|image: ghcr.io/${REPO_LC}:${{ github.sha }}|g" deployment.yaml

          # 4. Commit & Push
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add deployment.yaml
          # '|| true' suppresses the error if there is nothing new to commit
          git commit -m "Update image to ${{ github.sha }}" || true
          git push https://${GIT_TOKEN}@github.com/canepro/grade-api-gitops.git main
